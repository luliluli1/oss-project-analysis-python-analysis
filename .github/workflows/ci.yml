name: CI Pipeline

on:
  push:
    branches: [ main, code ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false
        persist-credentials: false
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m venv venv
        .\venv\Scripts\activate
        pip install -r requirements.txt
        # 明确安装报告生成依赖
        pip install pytest pytest-cov pytest-html coverage GitPython
    
    - name: Setup directory structure
      run: |
        mkdir -p data\repos
        mkdir -p reports\test\coverage
        mkdir -p reports\test\html
        Write-Host "✅ 目录结构创建成功"
        Get-ChildItem reports\test -Recurse
    
    - name: Clone requests repository
      run: |
        .\venv\Scripts\activate
        python src\setup_repo.py
      env:
        GIT_CONFIG_NOSYSTEM: 1
    
    - name: Debug environment before tests
      run: |
        .\venv\Scripts\activate
        Write-Host "=== Python 环境 ==="
        python --version
        pip list
        Write-Host "=== 项目结构 ==="
        Get-ChildItem -Recurse | Where-Object { $_.Name -like "test_*" -or $_.Name -eq "src" -or $_.Name -eq "tests" } | Format-Table -AutoSize
    
    - name: Run tests with comprehensive error handling
      id: run_tests
      run: |
        .\venv\Scripts\activate
        
        # 尝试1: 基本测试
        Write-Host "=== 尝试1: 运行基本测试 ==="
        $basicResult = pytest -v tests/unit/test_basic.py 2>&1
        Write-Host $basicResult
        
        # 尝试2: 详细报告生成
        Write-Host "`n=== 尝试2: 生成覆盖率报告 ==="
        $coverageResult = pytest -v tests/ --cov=src --cov-report=html:reports\test\coverage --cov-report=term-missing 2>&1
        Write-Host $coverageResult
        
        # 尝试3: 生成HTML报告
        Write-Host "`n=== 尝试3: 生成HTML报告 ==="
        $htmlResult = pytest -v tests/ --html=reports\test\html\report.html --self-contained-html 2>&1
        Write-Host $htmlResult
        
        # 验证报告是否生成
        Write-Host "`n=== 验证报告生成 ==="
        $htmlReport = "reports\test\html\report.html"
        $coverageIndex = "reports\test\coverage\index.html"
        
        if (Test-Path $htmlReport) {
            Write-Host "✅ HTML报告生成成功: $htmlReport"
            (Get-Item $htmlReport).Length
        } else {
            Write-Host "❌ HTML报告未生成"
        }
        
        if (Test-Path $coverageIndex) {
            Write-Host "✅ 覆盖率报告生成成功: $coverageIndex"
            (Get-Item $coverageIndex).Length
        } else {
            Write-Host "❌ 覆盖率报告未生成"
        }
        
        # 设置输出变量
        if ((Test-Path $htmlReport) -and (Test-Path $coverageIndex)) {
            Write-Host "::set-output name=reports_generated::true"
        } else {
            Write-Host "::set-output name=reports_generated::false"
        }
      continue-on-error: true  # 即使测试失败也继续，以便诊断
    
    - name: Upload HTML test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-report-html
        path: reports/test/html/report.html
        retention-days: 1
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: reports/test/coverage/
        retention-days: 1