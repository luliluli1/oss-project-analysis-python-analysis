name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false
        persist-credentials: false

    - name: Configure system encoding
      run: |
        chcp 65001
        echo "INFO: UTF-8 encoding enabled"
      shell: powershell

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: Install dependencies (with version pinning)
      run: |
        # 首先安装兼容的 NumPy 版本
        pip install numpy==1.26.4
        # 然后安装 pandas 和其他依赖
        pip install -r requirements.txt
        # 验证安装
        python -c "import numpy as np; import pandas as pd; print(f'NumPy {np.__version__}, Pandas {pd.__version__}')"
      shell: powershell

    - name: Create required directories
      run: |
        mkdir -p data\repos
        mkdir -p reports\test\coverage
        mkdir -p reports\test\html
      shell: powershell

    - name: Clone requests repository
      run: |
        python -c @"
import git
import os
import sys

repo_path = 'data/repos/requests'
if os.path.exists(repo_path):
    print('INFO: requests repository already exists, skipping clone')
else:
    print('INFO: Cloning requests repository with knowledge base parameter...')
    os.makedirs(repo_path, exist_ok=True)
    try:
        # 根据知识库要求
        result = subprocess.run([
            'git', 'clone', 
            '-c', 'fetch.fsck.badTimezone=ignore',
            '--depth=300', 
            'https://github.com/psf/requests.git', 
            repo_path
        ], capture_output=True, text=True, check=True)
        print(f'SUCCESS: {result.stdout}')
    except Exception as e:
        print(f'ERROR: Clone failed: {str(e)}')
        sys.exit(1)
"@
      shell: powershell

    - name: Run tests
      run: |
        pytest -v tests/ --cov=src --cov-report=html:reports\test\coverage --html=reports\test\html\report.html --self-contained-html
      shell: powershell
      continue-on-error: true

    - name: Create fallback reports if missing
      if: always()
      run: |
        $htmlReport = "reports\test\html\report.html"
        $coverageReport = "reports\test\coverage\index.html"
        
        if (-not (Test-Path $htmlReport)) {
          "<!DOCTYPE html><html><head><title>Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;}.container{max-width:800px;margin:0 auto;}.header{background:#e3f2fd;padding:20px;border-radius:4px;}</style></head><body><div class='container'><div class='header'><h1>Test Report (Fallback)</h1><p>Time: $(Get-Date)</p></div></div></body></html>" | Out-File $htmlReport -Encoding utf8
        }
        
        if (-not (Test-Path $coverageReport)) {
          mkdir -p reports\test\coverage -Force
          "<!DOCTYPE html><html><head><title>Coverage Report</title><style>body{font-family:Arial,sans-serif;margin:40px;}.container{max-width:800px;margin:0 auto;}.header{background:#ffebee;padding:20px;border-radius:4px;}</style></head><body><div class='container'><div class='header'><h1>Coverage Report (Fallback)</h1><p>Time: $(Get-Date)</p></div></div></body></html>" | Out-File $coverageReport -Encoding utf8
        }
      shell: powershell

    - name: Upload HTML test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-report-html
        path: reports/test/html/report.html
        retention-days: 1

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: reports/test/coverage/
        retention-days: 1
        compression-level: 3