name: Run Project Tests Only

on:
  push:
    branches: [ main, code ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m venv venv
        .\venv\Scripts\activate
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html coverage
    
    - name: Create report directories
      run: |
        mkdir -p reports\test\coverage
        mkdir -p reports\test\html
    
    - name: Debug project structure
      run: |
        Write-Host "=== 项目结构 ==="
        Get-ChildItem -Recurse | Where-Object { $_.PSIsContainer -or $_.Name -like "test_*.py" } | Format-Table -AutoSize
    
    - name: Run ONLY project tests
      run: |
        .\venv\Scripts\activate
        Write-Host "=== 运行项目测试 (仅tests/目录) ==="
        pytest -v tests/ --cov=src --cov-report=html:reports\test\coverage --cov-report=term-missing --html=reports\test\html\report.html --self-contained-html
    
    - name: Verify reports
      run: |
        if (-Not (Test-Path "reports\test\html\report.html")) {
            Write-Error "❌ HTML报告未生成"
            exit 1
        }
        if (-Not (Test-Path "reports\test\coverage\index.html")) {
            Write-Error "❌ 覆盖率报告未生成"
            exit 1
        }
        Write-Host "✅ 所有报告生成成功"
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: reports/test/coverage/
        retention-days: 1
    
    - name: Upload HTML test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-report-html
        path: reports/test/html/report.html
        retention-days: 1